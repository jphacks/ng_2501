# Math Video Maker - システムアーキテクチャ

## システム全体構成

```
┌─────────────────────────────────────────────────────────────────┐
│                         クライアント層                            │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │  Webブラウザ (PC / スマートフォン / タブレット)            │   │
│  └──────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
                              ↓ HTTPS
┌─────────────────────────────────────────────────────────────────┐
│                      フロントエンド層                             │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │           Next.js 15.5.4 + React 19.1.0                  │   │
│  │           (Turbopack / TypeScript / Tailwind CSS)        │   │
│  │                                                            │   │
│  │  ┌─────────────────────────────────────────────────────┐ │   │
│  │  │  Presentation Layer (src/components/)               │ │   │
│  │  │  - VideoGenerationFlow (状態管理)                   │ │   │
│  │  │  - Landing / Prompt / Generating / Result          │ │   │
│  │  └─────────────────────────────────────────────────────┘ │   │
│  │  ┌─────────────────────────────────────────────────────┐ │   │
│  │  │  UseCase Layer (src/app/hooks/)                     │ │   │
│  │  │  - useTextAnalysis (ビジネスロジック・API通信)      │ │   │
│  │  └─────────────────────────────────────────────────────┘ │   │
│  │  ┌─────────────────────────────────────────────────────┐ │   │
│  │  │  Domain Layer (src/app/datas/)                      │ │   │
│  │  │  - Video.ts (データモデル定義)                      │ │   │
│  │  └─────────────────────────────────────────────────────┘ │   │
│  └──────────────────────────────────────────────────────────┘   │
│                         Port: 3000                               │
└─────────────────────────────────────────────────────────────────┘
                              ↓ REST API
┌─────────────────────────────────────────────────────────────────┐
│                       バックエンド層                              │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │               FastAPI + uvicorn (Python 3.11)            │   │
│  │                                                            │   │
│  │  ┌─────────────────────────────────────────────────────┐ │   │
│  │  │  Router Layer (app/router/)                         │ │   │
│  │  │  - sample_router.py (エンドポイント定義)            │ │   │
│  │  └─────────────────────────────────────────────────────┘ │   │
│  │  ┌─────────────────────────────────────────────────────┐ │   │
│  │  │  Service Layer (app/service/)                       │ │   │
│  │  │  - sample_service.py (ビジネスロジック)             │ │   │
│  │  │  - AI処理 (LangChain + Gemini API)                 │ │   │
│  │  │  - 動画生成 (manim実行)                             │ │   │
│  │  └─────────────────────────────────────────────────────┘ │   │
│  │  ┌─────────────────────────────────────────────────────┐ │   │
│  │  │  Model Layer (app/model/)                           │ │   │
│  │  │  - sample_model.py (データモデル・DB操作)           │ │   │
│  │  └─────────────────────────────────────────────────────┘ │   │
│  └──────────────────────────────────────────────────────────┘   │
│                         Port: 8000                               │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                        外部サービス層                             │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │
│  │  Gemini API  │  │    manim     │  │   TinyTeX    │          │
│  │  (生成AI)     │  │ (数学動画生成)│  │ (LaTeX処理)  │          │
│  └──────────────┘  └──────────────┘  └──────────────┘          │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│                        データ永続化層                             │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │         PostgreSQL 16 (SQLAlchemy ORM)                   │   │
│  │         - ユーザーデータ                                   │   │
│  │         - 動画メタデータ                                   │   │
│  │         - プロンプト履歴                                   │   │
│  └──────────────────────────────────────────────────────────┘   │
│                         Port: 5432                               │
└─────────────────────────────────────────────────────────────────┘
```

## ディレクトリ構造

```
ai_agent/
├── front/                              # フロントエンド (Next.js)
│   ├── src/
│   │   ├── app/
│   │   │   ├── datas/                  # Domain層: データモデル定義
│   │   │   │   ├── Video.ts            # 動画生成のメインモデル
│   │   │   │   ├── Persona.ts          # ペルソナモデル
│   │   │   │   └── Tips.ts             # TIPSモデル
│   │   │   ├── hooks/                  # UseCase層: ビジネスロジック
│   │   │   │   └── useTextAnalysis.ts  # 動画生成フロー全体のロジック
│   │   │   ├── layout.tsx              # ルートレイアウト
│   │   │   ├── page.tsx                # トップページ
│   │   │   └── globals.css             # グローバルスタイル
│   │   └── components/                 # Presentation層: UIコンポーネント
│   │       ├── VideoGenerationFlow.tsx # フロー全体の状態管理
│   │       ├── landing/                # 状態1: ランディングページ
│   │       │   ├── Landing.tsx
│   │       │   └── MathTextInput.tsx   # 数式テキスト入力フォーム
│   │       ├── prompt/                 # 状態2: プロンプト確認ページ
│   │       │   ├── Prompt.tsx
│   │       │   └── PromptEditor.tsx    # プロンプト編集UI
│   │       ├── generating/             # 状態3: 動画生成中
│   │       │   └── Generating.tsx      # ローディング表示
│   │       └── result/                 # 状態4: リザルトページ
│   │           ├── Result.tsx
│   │           ├── VideoPlayer.tsx     # 動画プレイヤー
│   │           └── VideoEditDialog.tsx # 動画編集ダイアログ
│   ├── biome.json                      # Biome設定
│   ├── package.json                    # 依存関係管理
│   ├── tailwind.config.ts              # Tailwind CSS設定
│   └── tsconfig.json                   # TypeScript設定
│
├── back/                               # バックエンド (FastAPI)
│   ├── app/
│   │   ├── main.py                     # FastAPIアプリケーションエントリーポイント
│   │   ├── router/                     # Router層: エンドポイント定義
│   │   │   └── sample_router.py        # APIルーティング
│   │   ├── service/                    # Service層: ビジネスロジック
│   │   │   └── sample_service.py       # AI処理・動画生成ロジック
│   │   └── model/                      # Model層: データモデル・DB操作
│   │       └── sample_model.py         # Pydanticモデル・SQLAlchemyモデル
│   ├── pyproject.toml                  # Python依存関係管理 (uv)
│   └── uv.lock                         # 依存関係ロックファイル
│
├── docker-compose.yml                  # Docker Compose設定
├── .devcontainer/                      # VS Code DevContainer設定
├── DEVELOP.md                          # 開発環境構築手順
├── README.md                           # プロジェクト概要
├── ARCHITECTURE.md                     # システムアーキテクチャ
└── LICENSE                             # ライセンス
```

## 技術スタック詳細

### フロントエンド

| カテゴリ | 技術 | バージョン | 用途 |
|---------|------|-----------|------|
| ランタイム管理 | fnm | latest | Node.jsバージョン管理 |
| パッケージマネージャー | pnpm | 10.x | 高速パッケージ管理 |
| フレームワーク | Next.js | 15.5.4 | Reactベースのフルスタックフレームワーク |
| UIライブラリ | React | 19.1.0 | UIコンポーネント構築 |
| ビルドツール | Turbopack | - | 高速バンドラー（Next.js統合） |
| 言語 | TypeScript | 5.x | 型安全な開発 |
| スタイリング | Tailwind CSS | 3.x | ユーティリティファーストCSS |
| リンター・フォーマッター | Biome | latest | コード品質・整形 |

### バックエンド

| カテゴリ | 技術 | バージョン | 用途 |
|---------|------|-----------|------|
| 言語 | Python | 3.11 | サーバーサイド言語 |
| パッケージマネージャー | uv | latest | 高速Python依存関係管理 |
| Webフレームワーク | FastAPI | 0.118.2+ | REST API構築 |
| ASGIサーバー | uvicorn | 0.37.0+ | 非同期サーバー |
| ORM | SQLAlchemy | 2.0.43+ | データベース操作 |
| バリデーション | Pydantic | 2.12.0+ | データバリデーション |
| AI/LLM | LangChain | 0.3.27+ | LLMオーケストレーション |
| | LangChain Google GenAI | 2.1.12+ | Gemini API統合 |
| | LangGraph | 0.6.8+ | マルチエージェントワークフロー |
| 動画生成 | manim | 0.19.0+ | 数学アニメーション生成 |
| LaTeX処理 | TinyTeX | - | 軽量LaTeXエンジン |
| リンター・フォーマッター | Ruff | 0.14.0+ | 高速Python linter |

### データベース

| カテゴリ | 技術 | バージョン | 用途 |
|---------|------|-----------|------|
| RDBMS | PostgreSQL | 16 | メインデータベース |

### インフラ・開発環境

| カテゴリ | 技術 | 用途 |
|---------|------|------|
| コンテナ | Docker | 開発環境の統一 |
| オーケストレーション | Docker Compose | マルチコンテナ管理 |
| 開発環境 | VS Code DevContainer | 統一された開発体験 |

## データフロー

### 1. 動画生成フロー

```
[ユーザー] 
    ↓ (1) 数式テキスト入力
[フロントエンド: MathTextInput]
    ↓ (2) POST /api/generate-prompt
[バックエンド: Router]
    ↓ (3) サービス層へ委譲
[Service Layer]
    ↓ (4) LangChain + Gemini API
[Gemini API]
    ↓ (5) プロンプト + manimコード生成
[Service Layer]
    ↓ (6) レスポンス返却
[フロントエンド: PromptEditor]
    ↓ (7) ユーザーが確認・編集
[ユーザー]
    ↓ (8) 動画生成リクエスト
[バックエンド: Service Layer]
    ↓ (9) manimコード実行
[manim + TinyTeX]
    ↓ (10) MP4動画生成
[Service Layer]
    ↓ (11) 動画URL返却
[フロントエンド: VideoPlayer]
    ↓ (12) 動画表示
[ユーザー]
```

### 2. 動画編集フロー

```
[ユーザー]
    ↓ (1) 修正指示入力
[フロントエンド: VideoEditDialog]
    ↓ (2) POST /api/edit-video
[バックエンド: Service Layer]
    ↓ (3) 既存manimコード + 修正指示
[LangChain + Gemini API]
    ↓ (4) 修正されたmanimコード生成
[Service Layer]
    ↓ (5) manim再実行
[manim]
    ↓ (6) 新しい動画生成
[Service Layer]
    ↓ (7) 新しい動画URL返却
[フロントエンド: VideoPlayer]
    ↓ (8) 更新された動画表示
[ユーザー]
```

## API設計 (想定)

### エンドポイント一覧

| メソッド | エンドポイント | 説明 |
|---------|--------------|------|
| POST | `/api/generate-prompt` | テキストからプロンプト・manimコード生成 |
| POST | `/api/generate-video` | manimコードから動画生成 |
| POST | `/api/edit-video` | 動画の編集・再生成 |
| GET | `/api/videos/{video_id}` | 動画情報取得 |
| GET | `/api/videos` | 動画一覧取得 |

### リクエスト・レスポンス例

**POST /api/generate-prompt**

```json
// Request
{
  "text": "積分の基本的な計算方法を説明します。\\int_0^1 x^2 dx = [x^3/3]_0^1 = 1/3",
  "additionalPrompt": "積分記号を赤色で強調してほしい"
}

// Response
{
  "prompt": "積分の計算過程を段階的に表示し、積分記号を赤色で強調する動画を生成する",
  "manimCode": "from manim import *\n\nclass IntegralExample(Scene):\n    def construct(self):\n        ...",
  "originalText": "積分の基本的な計算方法を..."
}
```

## セキュリティ考慮事項

1. **入力バリデーション**: Pydanticによる厳密な型チェック
2. **manimコード実行の隔離**: Dockerコンテナ内での実行
3. **API認証**: 今後JWT/OAuth2実装予定
4. **レート制限**: APIリクエスト制限の実装
5. **環境変数管理**: 機密情報の安全な管理

## パフォーマンス最適化

1. **フロントエンド**
   - Turbopackによる高速ビルド
   - React 19のコンパイラ最適化
   - 遅延ローディング

2. **バックエンド**
   - FastAPIの非同期処理
   - manim動画生成のキャッシング
   - データベースクエリ最適化

3. **インフラ**
   - CDNによる動画配信
   - PostgreSQLのインデックス最適化

## デプロイ戦略

### フロントエンド
- **Vercel**: CI/CD統合、自動デプロイ
- **Git連携**: developブランチ → プレビュー環境
- **本番**: mainブランチ → 本番環境

### バックエンド
- **Docker Compose**: ステージング環境
- **クラウドプラットフォーム**: AWS/GCP/Azure（検討中）

### データベース
- **PostgreSQL**: マネージドサービス利用予定

## 今後の拡張計画

1. **共有機能**: ユーザー間での動画共有プラットフォーム
2. **認証機能**: ユーザー登録・ログイン
3. **音声ナレーション**: TTS統合
4. **リアルタイム共同編集**: WebSocket実装
5. **分析機能**: 動画視聴統計

